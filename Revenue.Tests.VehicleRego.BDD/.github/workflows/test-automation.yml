    - name: Create Test Summary with Screenshots
      if: always()
      shell: bash
      run: |
        echo "## ðŸ“Š Test Execution Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Parse TRX files for test results
        if [ -d "TestResults" ]; then
          TRX_FILES=$(find TestResults -name "*.trx" -type f)
          
          if [ ! -z "$TRX_FILES" ]; then
            # Extract test counts from TRX
            TOTAL=0
            PASSED=0
            FAILED=0
            
            for trx in $TRX_FILES; do
              if [ -f "$trx" ]; then
                T=$(grep -oP 'total="\K[0-9]+' "$trx" | head -1 || echo 0)
                P=$(grep -oP 'passed="\K[0-9]+' "$trx" | head -1 || echo 0)
                F=$(grep -oP 'failed="\K[0-9]+' "$trx" | head -1 || echo 0)
                TOTAL=$((TOTAL + T))
                PASSED=$((PASSED + P))
                FAILED=$((FAILED + F))
              fi
            done
            
            # Display test statistics
            echo "### ðŸ“ˆ Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Total Tests** | $TOTAL | 100% |" >> $GITHUB_STEP_SUMMARY
            
            if [ $TOTAL -gt 0 ]; then
              PASS_PCT=$((PASSED * 100 / TOTAL))
              echo "| âœ… **Passed** | $PASSED | ${PASS_PCT}% |" >> $GITHUB_STEP_SUMMARY
              
              if [ $FAILED -gt 0 ]; then
                FAIL_PCT=$((FAILED * 100 / TOTAL))
                echo "| âŒ **Failed** | $FAILED | ${FAIL_PCT}% |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # List all test results
            echo "### ðŸ“‹ Test Results Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Test Name | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY
            
            for trx in $TRX_FILES; do
              if [ -f "$trx" ]; then
                while IFS= read -r line; do
                  if [[ $line == *'<UnitTestResult'* ]]; then
                    TESTNAME=$(echo "$line" | grep -oP 'testName="\K[^"]+' || echo "Unknown")
                    OUTCOME=$(echo "$line" | grep -oP 'outcome="\K[^"]+' || echo "Unknown")
                    DURATION=$(echo "$line" | grep -oP 'duration="\K[^"]+' | sed 's/0://' || echo "N/A")
                    
                    if [ "$OUTCOME" = "Passed" ]; then
                      STATUS="âœ…"
                    elif [ "$OUTCOME" = "Failed" ]; then
                      STATUS="âŒ"
                    else
                      STATUS="â­ï¸"
                    fi
                    
                    CLEAN_NAME=$(echo "$TESTNAME" | sed 's/.*\.//' | sed 's/(.*//')
                    
                    echo "| $STATUS | \`$CLEAN_NAME\` | $DURATION |" >> $GITHUB_STEP_SUMMARY
                  fi
                done < "$trx"
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No TRX files found in TestResults" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ TestResults directory not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Screenshots section
        SCREENSHOT_COUNT=$(find . -name "FAILED_*.png" -type f 2>/dev/null | wc -l)
        
        if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
          echo "### ðŸ“¸ Failure Screenshots: $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Screenshot | Test |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
          
          find . -name "FAILED_*.png" -type f 2>/dev/null | while read screenshot; do
            filename=$(basename "$screenshot")
            testname=$(echo "$filename" | sed 's/FAILED_//' | sed 's/_[0-9]*\.png$//' | sed 's/_/ /g')
            echo "| ðŸ–¼ï¸ \`$filename\` | $testname |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download 'test-screenshots' artifact to view images**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Artifacts section
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ **test-results** - TRX test result files" >> $GITHUB_STEP_SUMMARY
        if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
          echo "- ðŸ“¥ **test-screenshots** - Screenshots from failed tests" >> $GITHUB_STEP_SUMMARY
        fi