name: Test Automation CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    defaults:
      run:
        working-directory: ./Revenue.Tests.VehicleRego.BDD
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: ${{ runner.os }}-nuget-
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: playwright-chromium-1.58.0
        restore-keys: playwright-chromium-
    
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build project
      run: dotnet build --no-restore --configuration Release
    
    # Remove or comment out the "Create env.json" step
    
    - name: Verify URL is accessible
      run: |
        echo "Testing URL accessibility..."
        RESPONSE=$(curl -sL -w "%{http_code}" "https://www.service.nsw.gov.au/transaction/check-motor-vehicle-stamp-duty" -o /dev/null)
        echo "HTTP Response Code: $RESPONSE"
        if [ "$RESPONSE" -eq "200" ] || [ "$RESPONSE" -eq "301" ] || [ "$RESPONSE" -eq "302" ]; then
          echo "âœ… URL is accessible"
        fi
    
    - name: Install Playwright browsers using build tools
      run: |
        echo "Installing Playwright browsers..."
        pwsh bin/Release/net8.0/playwright.ps1 install chromium --with-deps
        
        echo "âœ… Playwright browsers installed"
        echo "Checking installation..."
        ls -la ~/.cache/ms-playwright/ || echo "No cache directory"
    
    - name: Run Tests
      env:
        PLAYWRIGHT_URL: "https://www.service.nsw.gov.au/transaction/check-motor-vehicle-stamp-duty"
        PLAYWRIGHT_HEADLESS: "true"
        PLAYWRIGHT_BROWSER: "chromium"
        API_BASE_URL: "https://openlibrary.org/authors/OL1A.json"
      run: |
        dotnet test \
          --no-build \
          --configuration Release \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=test-results.trx" \
          --logger "console;verbosity=minimal"
      continue-on-error: true
      timeout-minutes: 10
    
    - name: List files for debugging
      if: always()
      run: |
        echo "=== Current Directory ==="
        pwd
        echo ""
        echo "=== Looking for screenshots ==="
        find . -name "*.png" -type f || echo "No PNG files found"
        echo ""
        echo "=== Looking for test results ==="
        find . -name "*.trx" -type f || echo "No TRX files found"
    
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-screenshots
        path: '**/screenshots/**/*.png'
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/TestResults/**/*.trx'
        retention-days: 30
        if-no-files-found: warn
    
    - name: Create Test Summary with Screenshots
      if: always()
      shell: bash
      run: |
        echo "## ðŸ“Š Test Execution Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Find TRX files anywhere in the workspace
        TRX_FILES=$(find . -name "*.trx" -type f 2>/dev/null)
        
        if [ -z "$TRX_FILES" ]; then
          echo "âš ï¸ **No test results found**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests may not have executed. Check the 'Run Tests' step logs." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“ˆ Test Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract test counts
          TOTAL=0
          PASSED=0
          FAILED=0
          
          for trx in $TRX_FILES; do
            T=$(grep -oP 'total="\K[0-9]+' "$trx" | head -1 || echo 0)
            P=$(grep -oP 'passed="\K[0-9]+' "$trx" | head -1 || echo 0)
            F=$(grep -oP 'failed="\K[0-9]+' "$trx" | head -1 || echo 0)
            TOTAL=$((TOTAL + T))
            PASSED=$((PASSED + P))
            FAILED=$((FAILED + F))
          done
          
          echo "| Metric | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Tests** | $TOTAL | 100% |" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL -gt 0 ]; then
            PASS_PCT=$((PASSED * 100 / TOTAL))
            echo "| âœ… **Passed** | $PASSED | ${PASS_PCT}% |" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -gt 0 ]; then
              FAIL_PCT=$((FAILED * 100 / TOTAL))
              echo "| âŒ **Failed** | $FAILED | ${FAIL_PCT}% |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Test Results Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Test Name | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for trx in $TRX_FILES; do
            while IFS= read -r line; do
              if [[ $line == *'<UnitTestResult'* ]]; then
                TESTNAME=$(echo "$line" | grep -oP 'testName="\K[^"]+' || echo "Unknown")
                OUTCOME=$(echo "$line" | grep -oP 'outcome="\K[^"]+' || echo "Unknown")
                DURATION=$(echo "$line" | grep -oP 'duration="\K[^"]+' | sed 's/0://' || echo "N/A")
                
                if [ "$OUTCOME" = "Passed" ]; then
                  STATUS="âœ…"
                elif [ "$OUTCOME" = "Failed" ]; then
                  STATUS="âŒ"
                else
                  STATUS="â­ï¸"
                fi
                
                # Clean test name: remove namespace (everything before the last dot that's not in parentheses)
                # First decode HTML entities, then clean namespace
                CLEAN_NAME=$(echo "$TESTNAME" | sed 's/&quot;/"/g' | sed 's/&amp;/\&/g' | sed 's/&lt;/</g' | sed 's/&gt;/>/g')
                
                # Remove namespace: match pattern like "Namespace.FeatureName.ScenarioName" -> "ScenarioName"
                # This pattern removes everything up to the last dot before any opening parenthesis or end of string
                CLEAN_NAME=$(echo "$CLEAN_NAME" | sed -E 's/^.*\.([^.(]+(\([^)]*\))?)$/\1/')
                
                echo "| $STATUS | $CLEAN_NAME | $DURATION |" >> $GITHUB_STEP_SUMMARY
              fi
            done < "$trx"
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Screenshots
        SCREENSHOT_COUNT=$(find . -name "FAILED_*.png" -type f 2>/dev/null | wc -l)
        
        if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
          echo "### ðŸ“¸ Failure Screenshots: $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Screenshot | Test |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
          
          find . -name "FAILED_*.png" -type f 2>/dev/null | while read screenshot; do
            filename=$(basename "$screenshot")
            testname=$(echo "$filename" | sed 's/FAILED_//' | sed 's/_[0-9]*\.png$//' | sed 's/_/ /g')
            echo "| ðŸ–¼ï¸ \`$filename\` | $testname |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download 'test-screenshots' artifact**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ **test-results** - TRX test result files" >> $GITHUB_STEP_SUMMARY
        if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
          echo "- ðŸ“¥ **test-screenshots** - Screenshots from failed tests" >> $GITHUB_STEP_SUMMARY
        fi